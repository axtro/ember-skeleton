APPNAME = 'ember-skeleton'

require 'json'
require 'rake-pipeline-web-filters'
require "uglifier"
require "execjs"

WebFilters = Rake::Pipeline::Web::Filters



class PrecompilingHandlebarsFilter < Rake::Pipeline::Filter

  include Rake::Pipeline::Web::Filters::FilterWithDependencies

  # @return [Hash] a hash of options for generate_output
  attr_reader :options

  # @param [Hash] options
  #   options to pass to the output generator
  # @option options [String] :target
  #   the variable to store templates in
  # @param [Proc] block a block to use as the Filter's
  #   {#output_name_generator}.
  def initialize(options={},&block)
    # Convert .handlebars file extensions to .js
    block ||= proc { |input| input.sub(/\.handlebars$/, '.js') }
    super(&block)
    @options = {
        :target =>'Ember.TEMPLATES',
        :wrapper_proc => proc { |source| "Ember.Handlebars.compile(#{source});" },
        :precompiler_wrapper_proc => proc { |precompiled| "Ember.Handlebars.template(#{precompiled});"},
        :key_name_proc => proc { |input| File.basename(input.path, File.extname(input.path)) }
      }.merge(options)
  end

  def generate_output(inputs, output)

    inputs.each do |input|
      # The name of the template is the filename, sans extension
      name = options[:key_name_proc].call(input)

      if options[:precompile]
        source = input.read

        precompiled = js_context.call("precompileEmberHandlebars", source)

        output.write "#{options[:target]}['#{name}']=#{options[:precompiler_wrapper_proc].call(precompiled)}"
      else
        # Read the file and escape it so it's a valid JS string
        source = input.read.to_json

        # Write out a JS file, saved to target, wrapped in compiler
        output.write "#{options[:target]}['#{name}']=#{options[:wrapper_proc].call(source)}"
      end
    end
  end

  private

  def js_context
    # We're using Ember to precompile templates
    unless @context
      headless = File.read("support/headless-ember.js")
      ember    = File.read("app/vendor/ember.js")
      @context = ExecJS.compile([headless, ember].join("\n"))
    end
    @context
  end

  def external_dependencies
    [ 'json' ]
  end
end


class EmberStripDebugFilter < Rake::Pipeline::Filter

  def strip_debug(data)
    # Strip debug code
    data.gsub!(%r{^(\s)+ember_(assert|deprecate|warn)\((.*)\).*$}, "")
  end


  def generate_output(inputs, output)
    inputs.each do |input|
      result = input.read
      strip_debug(result)
      output.write result
    end
  end
end

SHOULD_UGLIFY = ENV['RAKEP_MODE'] == 'production'

output 'assets'

input 'app' do
  match 'lib/**/*.js' do
    filter WebFilters::MinispadeFilter,
      :module_id_generator => proc { |input|
        input.path.sub(/^lib\//, "#{APPNAME}/").sub(/\.js$/, '')
      },
      :string => !SHOULD_UGLIFY,
      :rewrite_requires => true

    if SHOULD_UGLIFY
      filter EmberStripDebugFilter
      filter Rake::Pipeline::Web::Filters::UglifyFilter
    end
    concat 'app.js'
  end

  match 'vendor/**/*.js' do
    filter WebFilters::MinispadeFilter,
      :module_id_generator => proc { |input|
        input.path.sub(/^vendor\//, '').sub(/\.js$/, '')
      },
      :string => !SHOULD_UGLIFY,
      :rewrite_requires => true

    if SHOULD_UGLIFY
      filter EmberStripDebugFilter
      filter Rake::Pipeline::Web::Filters::UglifyFilter
    end
    concat %w[
      vendor/jquery.js
      vendor/ember.js
      vendor/ember-data.js
      vendor/sproutcore-routing.js
    ], 'app.js'
  end

  match 'templates/**/*.handlebars' do
    filter PrecompilingHandlebarsFilter,
      :key_name_proc => proc { |input| input.path.sub(/^templates\//, '').sub(/\.handlebars$/, '') },
      :precompile => SHOULD_UGLIFY
    filter WebFilters::MinispadeFilter,
      :module_id_generator => proc { |input|
        input.path.sub(/^templates\//, "#{APPNAME}/~templates/").sub(/\.handlebars$/, '').sub(/\.js$/, '')
      },
      :string => !SHOULD_UGLIFY,
      :rewrite_requires => true
    if SHOULD_UGLIFY
      filter Rake::Pipeline::Web::Filters::UglifyFilter
    end
    concat 'app.js'
  end

  match 'tests/**/*.js' do
    filter WebFilters::MinispadeFilter,
      :module_id_generator => proc { |input|
        input.path.sub(/^lib\//, "#{APPNAME}/").sub(/\.js$/, '')
      },
      :string => !SHOULD_UGLIFY,
      :rewrite_requires => true
    concat 'app-tests.js'
  end

  match 'css/**/*.css' do
    if SHOULD_UGLIFY
      yui_css
    end
    concat ['bootstrap.css', 'main.css'], 'app.css'
  end

  match 'css/**/*.scss' do
    sass
    if SHOULD_UGLIFY
      yui_css
    end
    concat 'app.css'
  end

  match "static/**/*" do
    concat do |input|
      input.sub(/static\//, '')
    end
  end
end

# vim: filetype=ruby
